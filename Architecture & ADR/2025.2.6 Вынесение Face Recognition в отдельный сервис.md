**Статус**: принято
**Дата**: 17 февраля 2025

**1. Контекст и постановка проблемы:**

Система "TL Food" должна предоставлять функцию идентификации пользователей (сотрудников компании) по лицу на кухне для быстрого получения заказа. Необходимо определить, как эта функция будет реализована в архитектуре системы. Ключевые требования:

- **Точность:** Высокая точность распознавания (минимизация ложноположительных и ложноотрицательных срабатываний).
- **Производительность:** Быстрое распознавание (не более 3 секунд).
- **Масштабируемость:** Возможность увеличения производительности при росте количества пользователей и/или запросов.
- **Надежность:** Бесперебойная работа сервиса распознавания.
- **Безопасность:** Защита персональных данных (фотографий) пользователей.
- **Технологическая гибкость:** Возможность использования наиболее подходящих технологий для распознавания лиц (которые могут отличаться от технологий, используемых для других компонентов системы).
    

**2. Рассматриваемые варианты:**

- **Вариант 1: Монолитная интеграция (Face Recognition в API Application).**
    
    - Описание: Встроить логику распознавания лиц непосредственно в API Application (основной бэкенд системы).
        
    - Реализация: Использовать библиотеки для распознавания лиц (например, Dlib, OpenCV, Face++) в рамках того же процесса, что и API Application (например, на C#).
        
    - Преимущества:
        
        - Простота реализации (не нужно настраивать взаимодействие между сервисами).
            
        - Минимальные задержки (нет сетевого взаимодействия).
            
    - Недостатки:
        
        - Сложность масштабирования (нужно масштабировать весь API Application, даже если нагрузка растет только на функцию распознавания).
            
        - Ограниченность в выборе технологий (привязаны к технологиям, используемым в API Application).
            
        - Усложнение кода API Application (смешение логики распознавания с другой бизнес-логикой).
            
        - Увеличение размера и сложности развертывания API Application.
            
- **Вариант 2: Микросервис Face Recognition (Face Recognition Service).**
    
    - Описание: Выделить логику распознавания лиц в отдельный микросервис (Face Recognition Service).
        
    - Реализация:
        
        - Разработать отдельное приложение (на C#, Python или другом языке), которое предоставляет API для распознавания лиц.
            
        - Использовать библиотеки для распознавания лиц (Dlib, OpenCV, Face++, Amazon Rekognition, Azure Face API, Google Cloud Vision API).
            
        - Взаимодействие с Kitchen Application (и, возможно, другими компонентами системы) через API (gRPC или REST).
            
        - Развернуть сервис на отдельном сервере (или в отдельном контейнере).
            
    - Преимущества:
        
        - **Масштабируемость:** Можно масштабировать сервис распознавания независимо от других компонентов системы.
            
        - **Технологическая гибкость:** Можно использовать наиболее подходящие технологии для распознавания (независимо от технологий, используемых в других частях системы).
            
        - **Независимость разработки:** Команды могут работать над сервисом распознавания и другими компонентами системы параллельно.
            
        - **Упрощение тестирования и развертывания:** Сервис распознавания можно тестировать и развертывать независимо.
            
        - **Отказоустойчивость:** Сбой в сервисе распознавания не приведет к отказу всей системы (если реализовать резервный механизм идентификации, например, ручной поиск).
            
    - Недостатки:
        
        - **Сложность архитектуры:** Необходимо настраивать взаимодействие между сервисами (API, аутентификация, авторизация).
            
        - **Задержки:** Появляются сетевые задержки при взаимодействии с сервисом распознавания.
            
        - **Управление распределенной системой:** Требуются дополнительные усилия по мониторингу, логированию и трассировке распределенной системы.
            

**3. Решение:**

Выбираем **вариант 2: Микросервис Face Recognition (Face Recognition Service).**

**4. Обоснование решения:**

Несмотря на некоторую сложность, микросервисная архитектура для Face Recognition предоставляет значительные преимущества в долгосрочной перспективе:

- **Масштабируемость:** Это ключевое преимущество. По мере роста количества пользователей и/или увеличения частоты использования системы, можно будет легко увеличить производительность сервиса распознавания, не затрагивая другие компоненты.
    
- **Технологическая гибкость:** Это позволяет использовать лучшие инструменты для распознавания лиц, не ограничиваясь технологическим стеком основного приложения. Можно экспериментировать с разными библиотеками и API, выбирать наиболее точные и производительные решения.
    
- **Независимость разработки и развертывания:** Это упрощает и ускоряет процесс разработки и внесения изменений.
    
- **Отказоустойчивость:** Выход из строя сервиса распознавания не приведет к полной неработоспособности системы (можно предусмотреть альтернативный способ идентификации, например, ручной поиск по табельному номеру).
    

Недостатки (сложность, задержки) можно минимизировать:

- **Сложность:** Использование современных инструментов и фреймворков (например, Docker, Kubernetes, gRPC) упрощает разработку и развертывание микросервисов.
    
- **Задержки:**
    
    - Оптимизация сетевого взаимодействия (использование gRPC вместо REST, если возможно).
        
    - Размещение сервиса распознавания на том же сервере (или в той же локальной сети), что и Kitchen Application, чтобы минимизировать задержки.
        
    - Кеширование результатов распознавания (если это допустимо).
        

**5. Детали реализации:**

- **Технологии:**
    
    - **Язык программирования:** Python (из-за большого количества библиотек и готовых решений для распознавания лиц) или C#.
        
    - **Библиотеки:** Dlib, OpenCV, Face_recognition (Python), Face++ (API), Amazon Rekognition (API), Azure Face API (API), или другие. Выбор конкретной библиотеки/API зависит от требований к точности, производительности, стоимости и наличия опыта у команды.
        
    - **API:** gRPC (более производительный) или REST.
        
    - **Контейнеризация:** Docker (для упрощения развертывания и масштабирования).
        
    - **Оркестрация:** Kubernetes (если потребуется масштабирование и высокая доступность).
        
- **Взаимодействие:**
    
    - Kitchen Application отправляет запрос на распознавание лица в Face Recognition Service, передавая изображение с веб-камеры.
        
    - Face Recognition Service обрабатывает изображение, выполняет распознавание и возвращает результат (Kitchen Application):
        
        - Идентификатор пользователя (если распознавание успешно).
            
        - Список возможных пользователей (если есть несколько похожих лиц).
            
        - Сообщение об ошибке (если распознавание не удалось).
            
- **Хранение данных:**
    
    - Фотографии пользователей хранятся в зашифрованном виде в отдельном хранилище (файловая система, облачное хранилище).
        
    - Доступ к фотографиям имеет только Face Recognition Service (и, возможно, администраторы системы).
        
    - В базе данных хранятся только идентификаторы пользователей и, возможно, хэши/векторы признаков лиц (но не сами фотографии).
        
- **Безопасность:**
    
    - Взаимодействие между Kitchen Application и Face Recognition Service должно быть защищено (HTTPS, аутентификация, авторизация).
        
    - Доступ к API Face Recognition Service должен быть ограничен (API key, OAuth 2.0).
        

**6. Последствия:**

- **Положительные:**
    
    - Высокая масштабируемость и отказоустойчивость системы.
        
    - Возможность использования лучших технологий для распознавания лиц.
        
    - Независимая разработка и развертывание сервиса распознавания.
        
    - Улучшенная тестируемость.
        
- **Отрицательные:**
    
    - Некоторое увеличение сложности архитектуры.
        
    - Небольшое увеличение задержек (сетевое взаимодействие).
        
    - Необходимость дополнительных усилий по обеспечению безопасности взаимодействия между сервисами.
        

**7. Метрики:**

- **Точность распознавания:** Процент успешных распознаваний (True Positives), процент ложноположительных срабатываний (False Positives), процент ложноотрицательных срабатываний (False Negatives). Целевые значения: True Positives >= 95%, False Positives <= 0.5%, False Negatives <= 5%.
    
- **Время распознавания:** Среднее время от начала процесса распознавания до получения результата. Целевое значение: <= 3 секунды.
    
- **Загрузка CPU и памяти** Face Recognition Service.
    
- **Количество запросов в секунду (RPS),** которое может обработать сервис.